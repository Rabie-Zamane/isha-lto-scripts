## Directory structure ##

**<lto4isha data home>/**

**<lto4isha data home>/tapes**   (top-level folder for tapes that have been built but not yet written to tape and verified)

**<lto4isha data home>/tapes/pending/123**   (tape that has already been built and given id 123, but it is not yet written to tape)

**<lto4isha data home>/tapes/written/123**   (tape that has already been written to tape not yet verified)

**<lto4isha data home>/tapes/verified/123**   (tape that has already been written to tape and verified and just waiting for deletion)

**<lto4isha data home>/tapes/work**  (temporary folder while we build a new tape - this sits between the tars folder and a new tapes subfolder)

**<lto4isha data home>/tars**  (all the session-device tars that have been created but not yet assigned to a tape)

**<lto4isha data home>/tars/work**  (temporary folder while we build a new tar archive)

Note - may want to subfolder /tars folder because there are certain tars you would never want to store on the same tape as each other.

## Scripts ##

  1. create-session-device-tar - more details for this step are outside the scope of this doc - essentially places a new tar in the /tars folder
  1. create-virtual-tape - iterates over the contents of the tapes/work folder, builds the index.xml file, imports it into the DB and move all tars (including index tar) into new /tapes/pending/123 folder (where 123 is the new tape id generated by the database)
  1. write-tape - given a specified tape id (corresponding to subfolder of /tapes/pending), writes all tar files to the tape drive and moves folder to equivalent /tapes/written/123 folder
  1. verify-tape - given a specified tape id (123), verifies that the contents of the /tapes/written/123 folder are the same as in the tape drive. If they are, then the folder is moved to /tapes/verified/123
  1. delete-virtual-tape - given a specified tape id (123), deletes the /tapes/verified/123 folder

Note - Only the first two scripts need to access the database.

## General workflow ##

  1. Create session-device tar
  1. Repeat step 1 until we decide we have enough tars for one tape (then proceed to next step)
  1. Manually copy required tars (some subset of the tar files in the /tars folder) into the /work folder
  1. Run the create-virtual-tape script
  1. Manually check over the contents of this new /tapes/pending/123 folder. If there is a problem then rollback by moving the session-device tars back to the /tars folder and removing the new /tapes/123 folder and new 123.xml resource in the /db/lto4isha/tapes database collection (and then go back to step 4).  IDEA - Have a dismantle-tape script that reverses the changes done by prepare-tape script.
  1. Run the write-tape script.
  1. Run the verify-tape script. If it fails then go back to step 6 (or earlier should the error indicate a more fundamental problem)
  1. Run the delete-virtual-tape script.